
use DataWarehouseAnalytics
go
select 
distinct country 
from gold.dim_customers

-- Explore all the category 
select
distinct category,subcategory,product_name from gold.dim_products

--- Date Exploration 

-- date of first and last order 
select 
max(order_date) as last_order,
min(order_date) as first_order
from gold.fact_sales

-- how many years of sales are availabel
select 
abs(datediff(month ,max(order_date) , min(order_date)))
from gold.fact_sales

-- to find youngest and oldest customer
SELECT
    MIN(birthdate) AS oldest_birthdate,
    DATEDIFF(YEAR, MIN(birthdate), GETDATE()) AS oldest_age,
    max(birthdate) as eldest_brthdate,
    datediff(year,max(birthdate), getdate()) as eldest_age
from gold.dim_customers

-- find the total_Sale
SELECT
    CONCAT(
        cast(ROUND(SUM(sales_amount) / 1000000.0, 3) as decimal(10,2)),
        ' Million'
    ) AS total_sales
FROM gold.fact_sales;

-- to find sold item 
select
    sum(quantity) as total_quantity 
from gold.fact_sales

-- find avg. selling price
select 
(sum(price)/sum(quantity)) as avg_sale_price,
avg(price) as avg_price
from gold.fact_sales

-- to get total order
select
count(distinct order_number ) as total_orders
from gold.fact_sales

-- Find the total number of products
SELECT COUNT(product_name) AS total_products ,
category,
subcategory
FROM gold.dim_products
group by category, subcategory
order by category , subcategory

-- Find the total number of customers
SELECT COUNT(customer_key) AS total_customers FROM gold.dim_customers;

-- find the number of customer age wise
select
case
    when age between 40 and 49 then '40to49'
    when age between 30 and 39 then '30to39'
    end as age_group,
count(*) as cust_count
from(
SELECT
        DATEDIFF(YEAR, birthdate, GETDATE()) AS age
    FROM gold.dim_customers
) t
WHERE age BETWEEN 30 AND 49
group by 
    case 
         when age between 40 and 49  then '40to49'
         when age between 30 and 39 then '30to39'
    end 

    -- Find the total number of customers that has placed an order

    select
    count(customer_key) as active_cust
    from gold.dim_customers
    where customer_key in (select customer_key from gold.fact_sales)

    -- Generate a Report that contain all key metrics of the business

SELECT 'Total_Sales' AS measure_name, SUM(sales_amount) AS measure_value FROM gold.fact_sales
UNION ALL
SELECT 'Total Quantity', SUM(quantity) FROM gold.fact_sales
UNION ALL
SELECT 'Avg_Price', AVG(price) FROM gold.fact_sales
UNION ALL
SELECT 'Total Orders', COUNT(DISTINCT order_number) FROM gold.fact_sales
UNION ALL
SELECT 'Distnt_Products', COUNT(DISTINCT product_name) FROM gold.dim_products
UNION ALL
SELECT 'Total Customers', COUNT(customer_key) FROM gold.dim_customers


-- find total sale by country 
SELECT
    c.country,
    SUM(s.sales_amount) AS total_sales
FROM gold.dim_customers c
JOIN gold.fact_sales s
    ON c.customer_key = s.customer_key
GROUP BY c.country;

-- total quantity by category---------
SELECT COUNT(quantity) AS total_quantity ,
category,
subcategory
FROM gold.dim_products p
join gold.fact_sales s
on p.product_key = s.product_key
group by category, subcategory
order by category ,COUNT(quantity)


----------- Avg Price by Category ________________
SELECT
    p.category,
    AVG(price) AS cat_avg_price
FROM gold.dim_products p
JOIN gold.fact_sales s
    ON p.product_key = s.product_key
GROUP BY p.category

------- avg_cost_by _category ------------
select
category,
avg(cost) as avg_cost
from gold.dim_products p
group by category 
order by avg(cost) DESC

----- total revenue generated by each category -----------
select 
category,
concat(
cast(sum(price)/1000000.0 as decimal(10,2)) , ' Million') as revenue_catg
from gold.fact_sales s
join gold.dim_products p
on s.product_key = p.product_key
group by category

-- revenue generated by each customer ------
select
c.customer_key,
c.first_name,
c.last_name,
sum(s.sales_amount) as rev_pr_cust
from gold.dim_customers c
left join gold.fact_sales s
on s.customer_key = c.customer_key
group by c.customer_key,c.first_name,c.last_name
order by rev_pr_cust

-- quantity distribution by country ___

select
c.country,
sum(s.quantity) as tot_quantity
from gold.dim_customers c
left join gold.fact_sales s
on s.customer_key = c.customer_key
group by c.country
order by tot_quantity


-- Top 10 product of sale
select top 10
p.product_name,
sum(s.sales_amount) as total_sale
from gold.fact_sales s
join gold.dim_products p
on s.product_key = p.product_key
group by p.product_name
order by total_sale DESC 

-- top distinct product  of high sale---
with cte as (
select 
p.product_name,
category,
sum(s.sales_amount) as total_sale
from gold.fact_sales s
join gold.dim_products p
on s.product_key = p.product_key
GROUP BY p.product_name, category
),
ranked_products AS (
    SELECT
        category,
        product_name,
        total_sale,
        ROW_NUMBER() OVER (
            PARTITION BY category
            ORDER BY total_sale DESC
        ) AS rnk
    FROM cte)
select
    category,
    product_name,
    total_sale
FROM ranked_products
WHERE rnk = 1;



-- Rank Top country by total sales --------
 SELECT
        c.country,
        SUM(s.sales_amount) AS total_sales
    FROM gold.dim_customers c
    JOIN gold.fact_sales s
        ON c.customer_key = s.customer_key
    GROUP BY c.country 
    order by total_sales DESC


    -- top 10 customer who generated the highest revenue ---
select top 10  
    c.customer_key,
    c.first_name,
    c.last_name,
    sum(s.sales_amount) as rev_pr_cust
from gold.dim_customers c
left join gold.fact_sales s
on s.customer_key = c.customer_key
group by c.customer_key,c.first_name,c.last_name
order by rev_pr_cust DESC
